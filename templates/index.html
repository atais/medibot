<!DOCTYPE html>
<html lang="pl">

<head>
    <title>MEDIBOT | Home</title>
    {% include 'head.html' %}
</head>

<body>
{% include 'navbar.html' %}

<div class="container-fluid px-2 px-md-4 py-3">
    <div class="row g-4">
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Utwórz monitor</h2>
                    <form method="get" action="/search" class="row g-3 mb-4" id="monitor-form">
                        <input type="hidden" id="search_region_ids" name="region_ids" value="{{ profile.home_clinic }}"
                               required>
                        <div class="col-md-12">
                            <label for="specialty_select" class="form-label">Specjalności</label>
                            <select class="selectpicker w-100" id="specialty_select" name="specialty_ids" multiple
                                    data-none-Selected-Text="Wybierz specjalności"
                                    data-live-search="true" required>
                                {% for specialty_id, specialty_name in all_specialities.items() %}
                                    <option value="{{ specialty_id }}">{{ specialty_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="start_time" class="form-label">Data początkowa</label>
                            <div class="input-group">
                                <input type="text" id="start_time" name="start_time" required class="form-control" />
                                <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                            </div>
                        </div>
                        <div class="col-md-12 d-flex justify-content-start">
                            <button type="submit" class="btn btn-success w-auto">
                                <i class="bi bi-search"></i> Szukaj wizyt
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Aktywne monitory</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Job ID</th>
                                <th>Następne uruchomienie</th>
                                <th>Status</th>
                                <th>Usuń</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td>{{ job.name }}</td>
                                <td>{{ job.next_run_time | datetimeformat('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% if job.next_run_time is none %}
                                    <form method="get" action="/resume_job/{{ job.id }}">
                                        <button type="submit" class="btn btn-success btn-sm" aria-label="Resume job">
                                            <i class="bi bi-play-fill"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="get" action="/pause_job/{{ job.id }}">
                                        <button type="submit" class="btn btn-secondary btn-sm" aria-label="Pause job">
                                            <i class="bi bi-pause-fill"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="/remove_job/{{ job.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" aria-label="Usuń">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Zaplanowane wizyty</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Specjalność</th>
                                <th>Klinika</th>
                                <th>Lekarz</th>
                                <th>Usuń</th>
                                <th>Zamień</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for a in appointments.items %}
                            <tr>
                                <td>{{ a.date | datetimeformat('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ a.specialty.name }}</td>
                                <td>{{ a.clinic.name }}</td>
                                <td>{{ a.doctor.name }}</td>
                                <td>
                                    <form method="get" action="/delete" style="display:inline;">
                                        <input type="hidden" name="appointment_id" value="{{ a.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" aria-label="Usuń">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                                <td>
                                    <a href="/search?region_ids={{ a.region.id }}&specialty_ids={{ a.specialty.id }}&clinic_ids={{ a.clinic.id }}&doctor_ids={{ a.doctor.id }}&previous_id={{ a.id }}"
                                       class="btn btn-outline-primary btn-sm" aria-label="Zamień">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Skierowania</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Data ważności</th>
                                <th>Status</th>
                                <th>Usługa</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for referral in referrals.items %}
                            <tr>
                                <td>{{ referral.expirationDate | datetimeformat('%Y-%m-%d') }}</td>
                                <td>{{ referral.referralStatus }}</td>
                                <td>
                                    {% if referral.services and referral.services[0].service %}
                                    {{ referral.services[0].service.name }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Profil</h2>
                    <form method="post" action="/update_profile" class="mb-3">
                        <div class="mb-3 w-100">
                            <label for="region_select" class="form-label">Region</label>
                            <select class="selectpicker w-100" id="region_select" name="region_id" data-live-search="true" required>
                                {% for region_id, region_value in all_regions.items() %}
                                <option value="{{ region_id }}" {% if profile.home_clinic == region_id %}selected{% endif %}>{{ region_value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Zapisz zmiany
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set up datepicker for start_time
        const startTimeInput = document.getElementById('start_time');
        if (startTimeInput) {
            $(startTimeInput).datepicker({
                format: 'yyyy-mm-dd',
                language: 'pl',
                autoclose: true,
                todayHighlight: true
            });
            // Set default value to today if empty
            if (!startTimeInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                startTimeInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }
    });
</script>
</body>

</html>
