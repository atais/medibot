<!DOCTYPE html>
<html lang="pl">

<head>
    <title>MEDIBOT | Home</title>
    {% include 'head.html' %}
</head>

<body>
{% include 'navbar.html' %}

<div class="container-fluid px-2 px-md-4 py-3">
    <div class="row g-4">
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Utwórz monitor</h2>
                    <form method="get" action="/search" class="row g-3 mb-4" id="monitor-form">
                        <input type="hidden" id="search_region_ids" name="region_ids" value="{{ profile.home_clinic }}"
                               required>
                        <div class="col-md-12">
                            <label for="specialty_name" class="form-label">Specjalności</label>
                            <input type="text" class="form-control" id="specialty_name" autocomplete="off"
                                   placeholder="Wybierz specjalności...">
                            <input type="hidden" id="specialty_ids" name="specialty_ids" required>
                            <div id="specialty-autocomplete-list" class="list-group position-absolute w-100"
                                 style="z-index: 1000;"></div>
                            <div id="specialties-selected-list" class="mt-2"></div>
                        </div>
                        <div class="col-md-12">
                            <label for="start_time" class="form-label">Data początkowa (YYYY-MM-DD)</label>
                            <input type="text" class="form-control" id="start_time" name="start_time" required
                                   autocomplete="off">
                        </div>
                        <div class="col-md-12 d-flex justify-content-start">
                            <button type="submit" class="btn btn-success w-auto">
                                <i class="bi bi-search"></i> Szukaj wizyt
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Aktywne monitory</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Job ID</th>
                                <th>Następne uruchomienie</th>
                                <!--                                <th>Edycja</th>-->
                                <th>Usuń</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td>{{ job.id }}</td>
                                <td>{{ job.next_run_time }}</td>
                                <!--                                <td>-->
                                <!--                                    <form method="get" action="/edit_job/{{ job.id }}">-->
                                <!--                                        <button type="submit" class="btn btn-secondary btn-sm" disabled-->
                                <!--                                                aria-label="Edytuj">-->
                                <!--                                            <i class="bi bi-pencil"></i>-->
                                <!--                                        </button>-->
                                <!--                                    </form>-->
                                <!--                                </td>-->
                                <td>
                                    <form method="post" action="/remove_job/{{ job.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" aria-label="Usuń">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Skierowania</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Data ważności</th>
                                <th>Status</th>
                                <th>Usługa</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for referral in referrals.items %}
                            <tr>
                                <td>{{ referral.expirationDate }}</td>
                                <td>{{ referral.referralStatus }}</td>
                                <td>
                                    {% if referral.services and referral.services[0].service %}
                                    {{ referral.services[0].service.name }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Profil</h2>
                    <form method="post" action="/update_profile" class="mb-3">
                        <div class="mb-3 w-100">
                            <label for="region_select" class="form-label">Region</label>
                            <select class="selectpicker w-100" id="region_select" name="region_id" data-live-search="true" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Zapisz zmiany
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Expose profile.home_clinic to JS
        const userHomeClinic = "{{ profile.home_clinic }}";
        let regions = [];
        let specialties = [];
        let selectedSpecialties = [];

        fetch('/static/locations.json')
            .then(response => response.json())
            .then(data => {
                regions = data.regions || [];
                const regionSelect = document.getElementById('region_select');
                regionSelect.innerHTML = '';
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.value;
                    if (region.id == userHomeClinic) {
                        option.selected = true;
                    }
                    regionSelect.appendChild(option);
                });
                // Initialize bootstrap-select
                $('.selectpicker').selectpicker('refresh');
            });

        // Load specialties
        fetch('/static/specialities.json')
            .then(response => response.json())
            .then(data => {
                specialties = data;
            });

        // Specialty autocomplete logic
        const specialtyInput = document.getElementById('specialty_name');
        const specialtyIdsInput = document.getElementById('specialty_ids');
        const specialtyAutocompleteList = document.getElementById('specialty-autocomplete-list');
        const specialtiesSelectedList = document.getElementById('specialties-selected-list');
        const regionInput = document.getElementById('region_name');
        const regionIdInput = document.getElementById('region_id');

        function updateSpecialtyBadges() {
            specialtiesSelectedList.innerHTML = '';
            selectedSpecialties.forEach(spec => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.textContent = spec.name.trim();
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn-close btn-close-white btn-sm ms-1';
                removeBtn.style.fontSize = '0.7em';
                removeBtn.onclick = function () {
                    selectedSpecialties = selectedSpecialties.filter(s => s.id !== spec.id);
                    updateSpecialtyBadges();
                    updateSpecialtyIdsInput();
                };
                badge.appendChild(removeBtn);
                specialtiesSelectedList.appendChild(badge);
            });
        }

        function updateSpecialtyIdsInput() {
            specialtyIdsInput.value = selectedSpecialties.map(s => s.id).join(',');
        }

        specialtyInput.addEventListener('input', function () {
            const val = this.value.toLowerCase();
            specialtyAutocompleteList.innerHTML = '';
            if (!val) return;
            const matches = specialties.filter(s => s.name.toLowerCase().includes(val) && !selectedSpecialties.some(sel => sel.id === s.id));
            matches.slice(0, 10).forEach(spec => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = spec.name.trim();
                item.onclick = function () {
                    selectedSpecialties.push(spec);
                    updateSpecialtyBadges();
                    updateSpecialtyIdsInput();
                    specialtyInput.value = '';
                    specialtyAutocompleteList.innerHTML = '';
                };
                specialtyAutocompleteList.appendChild(item);
            });
        });

        specialtyInput.addEventListener('focus', function () {
            if (this.value === '' && specialties.length > 0) {
                specialtyAutocompleteList.innerHTML = '';
                specialties.filter(s => !selectedSpecialties.some(sel => sel.id === s.id)).slice(0, 10).forEach(spec => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = spec.name.trim();
                    item.onclick = function () {
                        selectedSpecialties.push(spec);
                        updateSpecialtyBadges();
                        updateSpecialtyIdsInput();
                        specialtyInput.value = '';
                        specialtyAutocompleteList.innerHTML = '';
                    };
                    specialtyAutocompleteList.appendChild(item);
                });
            }
        });


        // On form submit, ensure region_ids is set to the selected region's ID
        const monitorForm = document.getElementById('monitor-form');
        monitorForm.addEventListener('submit', function (e) {
            // If the region name doesn't match any region, prevent submit
            const selected = regions.find(r => r.value === regionInput.value);
            if (selected) {
                regionIdInput.value = selected.id;
            } else {
                regionIdInput.value = '';
                regionInput.value = '';
                e.preventDefault();
                regionInput.classList.add('is-invalid');
                regionInput.setCustomValidity('Wybierz region z listy.');
                regionInput.reportValidity();
            }
            // Validate specialties
            if (!specialtyIdsInput.value) {
                e.preventDefault();
                specialtyInput.classList.add('is-invalid');
                specialtyInput.setCustomValidity('Wybierz co najmniej jedną specjalność.');
                specialtyInput.reportValidity();
            } else {
                specialtyInput.classList.remove('is-invalid');
                specialtyInput.setCustomValidity('');
            }
        });
        specialtyInput.addEventListener('input', function () {
            specialtyInput.classList.remove('is-invalid');
            specialtyInput.setCustomValidity('');
        });

        // Set up datepicker for start_time
        const startTimeInput = document.getElementById('start_time');
        if (startTimeInput) {
            $(startTimeInput).datepicker({
                format: 'yyyy-mm-dd',
                language: 'pl',
                autoclose: true,
                todayHighlight: true
            });
            // Set default value to today if empty
            if (!startTimeInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                startTimeInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }
    });
</script>
</body>

</html>
